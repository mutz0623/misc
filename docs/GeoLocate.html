<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>現在位置 → 緯度経度（各種）/ UTM(MGRS) / Plus Code</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121831;
      --text: #e8ecff;
      --muted: #aab2d5;
      --accent: #6ea8fe;
      --ok: #2ecc71;
      --warn: #ffb020;
      --err: #ff5c5c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'Yu Gothic', sans-serif;
      background: linear-gradient(180deg, #0b1020, #090d1a 60%);
      color: var(--text);
    }

    header {
      padding: 24px 16px;
      text-align: center;
    }

    header h1 {
      margin: 0 0 6px;
      font-size: clamp(20px, 4vw, 28px);
      letter-spacing: .3px;
    }

    header p {
      margin: 0;
      color: var(--muted);
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .card {
      background: radial-gradient(120% 140% at 0% 0%, #1a2147 0%, #121831 40%, #0e142a 100%);
      border: 1px solid #1f2a55;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #dfe6ff;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button,
    .btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: linear-gradient(180deg, #2a6bff, #184ad8);
      color: white;
      font-weight: 600;
      transition: transform .08s ease, filter .2s ease;
    }

    button:hover {
      filter: brightness(1.05);
    }

    button:active {
      transform: translateY(1px) scale(.995);
    }

    .btn-secondary {
      background: linear-gradient(180deg, #2b324f, #1c2444);
      color: #e0e6ff;
      border: 1px solid #2a376a;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      letter-spacing: .2px;
      font-size: 14px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a376a;
      background: #0c1230;
      color: var(--text);
    }

    .grid {
      display: grid;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: #0d1539;
      border: 1px solid #283367;
      color: #cbd6ff;
      font-size: 12px;
    }

    .copy {
      padding: 6px 10px;
      border-radius: 8px;
      background: #18224b;
      color: #dfe6ff;
      border: 1px solid #2a376a;
      cursor: pointer;
    }

    .copy.ok {
      background: #173824;
      border-color: #1c6a3a;
    }

    .status {
      font-size: 13px;
      min-height: 1.5em;
      color: var(--muted);
    }

    footer {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      color: #9fb0ff;
      font-size: 12px;
      opacity: .9;
    }

    .small {
      font-size: 12px;
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono';
      background: #10173a;
      border: 1px solid #2a376a;
      padding: 0 6px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <header>
    <h1>現在位置を取得 → 座標を多形式で表示</h1>
    <p>緯度経度（DD / DDM / DMS / GeoURI）、UTM / MGRS、Plus Code を1ページで</p>
  </header>

  <main>
    <section class="card" style="grid-column: 1 / -1;">
      <h2>取得 & 入力</h2>
      <div class="controls">
        <button id="btnLocate">現在位置を取得</button>
        <button id="btnWatch" class="btn-secondary">追従（watchPosition）</button>
        <button id="btnStop" class="btn-secondary">停止</button>
        <span id="perm" class="pill">権限: <span id="permState">未知</span></span>
        <span class="pill">測位: <span id="fixState">未開始</span></span>
      </div>
      <div class="grid" style="margin-top:12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
        <div>
          <label class="muted">緯度 (°)</label>
          <input id="latInput" type="number" step="0.000001" placeholder="例: 35.681236" />
        </div>
        <div>
          <label class="muted">経度 (°)</label>
          <input id="lonInput" type="number" step="0.000001" placeholder="例: 139.767125" />
        </div>
        <div style="align-self:end;">
          <button id="btnApply" class="btn" style="width:100%;">この値で更新</button>
        </div>
      </div>
      <div id="status" class="status"></div>
    </section>

    <section class="card">
      <h2>緯度経度（各種）</h2>
      <div class="row"><span class="muted">十進法 (DD)</span><button class="copy" data-copy="dd"></button></div>
      <div id="dd" class="mono">—</div>
      <div class="row"><span class="muted">度分 (DDM)</span><button class="copy" data-copy="ddm"></button></div>
      <div id="ddm" class="mono">—</div>
      <div class="row"><span class="muted">度分秒 (DMS)</span><button class="copy" data-copy="dms"></button></div>
      <div id="dms" class="mono">—</div>
      <div class="row"><span class="muted">Geo URI</span><button class="copy" data-copy="geouri"></button></div>
      <div id="geouri" class="mono">—</div>
    </section>

    <section class="card">
      <h2>UTM & MGRS</h2>
      <div class="row"><span class="muted">UTM (WGS84)</span><button class="copy" data-copy="utm"></button></div>
      <div id="utm" class="mono">—</div>
      <div class="row"><span class="muted">MGRS (100m)</span><button class="copy" data-copy="mgrs"></button></div>
      <div id="mgrs" class="mono">—</div>
    </section>

    <section class="card">
      <h2>Plus Code</h2>
      <div class="row"><span class="muted">Open Location Code</span><button class="copy" data-copy="olc"></button></div>
      <div id="olc" class="mono">—</div>
      <div class="row"><span class="muted">短縮（参照地点なし）</span><button class="copy" data-copy="olc8"></button></div>
      <div id="olc8" class="mono">—</div>
    </section>
  </main>

  <footer>
    <div>⚠️ ブラウザの位置情報許可が必要です（HTTPS推奨）。屋内や精度が低い場合は手入力をご利用ください。</div>
    <div style="margin-top:6px;" class="small">出力は <span class="kbd">WGS84</span>。UTMは北半球/南半球を自動判定。MGRSは100mグリッドで丸め。
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/openlocationcode/latest/openlocationcode.js"></script>
  <script>
    // ========= ユーティリティ =========
    const qs = (s, el = document) => el.querySelector(s);
    const qsa = (s, el = document) => [...el.querySelectorAll(s)];
    const fmt = n => n.toLocaleString(undefined, { maximumFractionDigits: 6 });
    function toDMS(deg, lat = true) {
      const d = Math.floor(Math.abs(deg));
      const minFloat = (Math.abs(deg) - d) * 60;
      const m = Math.floor(minFloat);
      const s = (minFloat - m) * 60;
      const hemi = lat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
      return `${d}°${String(m).padStart(2, '0')}'${s.toFixed(2).padStart(5, '0')}" ${hemi}`;
    }
    function toDDM(deg, lat = true) {
      const d = Math.floor(Math.abs(deg));
      const min = (Math.abs(deg) - d) * 60;
      const hemi = lat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
      return `${d}°${min.toFixed(4)}' ${hemi}`;
    }

    // ========= OLC (Plus Code) エンコード =========
    window.olcEncode = function (lat, lon, codeLen = 11) {
      return OpenLocationCode.encode(lat, lon, codeLen);
    };

    // ========= UTM / MGRS 変換 =========
    // WGS84 -> UTM (Transverse Mercator)
    const WGS84 = { a: 6378137.0, f: 1 / 298.257223563 };
    WGS84.b = WGS84.a * (1 - WGS84.f);
    WGS84.e2 = (WGS84.a ** 2 - WGS84.b ** 2) / WGS84.a ** 2; // first eccentricity squared
    WGS84.e2p = (WGS84.a ** 2 - WGS84.b ** 2) / WGS84.b ** 2; // second eccentricity squared
    const K0 = 0.9996;

    function latLonToUTM(lat, lon) {
      if (lon === 180) lon = 179.999999; // avoid edge
      const zone = Math.floor((lon + 180) / 6) + 1;
      // ノルウェー/スヴァールバル特例（MGRS慣例）—UTMは通常通りでOK、MGRS側で処理
      const λ0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180; // 中央子午線
      const φ = lat * Math.PI / 180; const λ = lon * Math.PI / 180;
      const N = WGS84.a / Math.sqrt(1 - WGS84.e2 * Math.sin(φ) ** 2);
      const T = Math.tan(φ) ** 2;
      const C = WGS84.e2p * Math.cos(φ) ** 2;
      const A = Math.cos(φ) * (λ - λ0);
      // 子午線弧長
      const e4 = WGS84.e2 ** 2, e6 = WGS84.e2 ** 3;
      const M = WGS84.a * (
        (1 - WGS84.e2 / 4 - 3 * e4 / 64 - 5 * e6 / 256) * φ
        - (3 * WGS84.e2 / 8 + 3 * e4 / 32 + 45 * e6 / 1024) * Math.sin(2 * φ)
        + (15 * e4 / 256 + 45 * e6 / 1024) * Math.sin(4 * φ)
        - (35 * e6 / 3072) * Math.sin(6 * φ)
      );
      let easting = K0 * N * (A + (1 - T + C) * A ** 3 / 6 + (5 - 18 * T + T ** 2 + 72 * C - 58 * WGS84.e2p) * A ** 5 / 120) + 500000.0;
      let northing = K0 * (M + N * Math.tan(φ) * (A ** 2 / 2 + (5 - T + 9 * C + 4 * C ** 2) * A ** 4 / 24 + (61 - 58 * T + T ** 2 + 600 * C - 330 * WGS84.e2p) * A ** 6 / 720));
      const hemisphere = (lat >= 0) ? 'N' : 'S';
      if (lat < 0) northing += 10000000.0; // 南半球補正
      return { zone, hemisphere, easting, northing };
    }

    // UTM → MGRS（100m精度）
    const MGRS_COL = ['ABCDEFGH', 'JKLMNPQR', 'STUVWXYZ']; // 8,8,8
    const MGRS_ROW = 'ABCDEFGHJKLMNPQRSTUV'; // 20 letters
    function latitudeBand(lat) {
      const bands = 'CDEFGHJKLMNPQRSTUVWX'; // 8° bands, X=12°
      if (lat >= 84) return 'X';
      if (lat <= -80) return 'C';
      const idx = Math.floor((lat + 80) / 8);
      return bands[idx] || 'X';
    }
    function utmToMgrs(lat, utm) {
      const { zone, hemisphere, easting, northing } = utm;
      const band = latitudeBand(lat);

      // 100kmグリッド識別
      const e100k = Math.floor(easting / 100000);
      const n100k = Math.floor(northing / 100000);

      // グリッド列（column）の計算
      const setColumn = ((zone - 1) % 3);
      const colLetters = MGRS_COL[setColumn];
      const col = colLetters[(e100k - 1) % 8];

      // グリッド行（row）の計算
      // ゾーンごとに行の開始位置が変わる
      const setRow = ((zone - 1) % 2) * 5; // 奇数ゾーンは0、偶数ゾーンは5から開始
      const finalRow = (n100k + setRow) % 20;
      const row = MGRS_ROW[finalRow];

      // 100mグリッドの数値
      const e100m = Math.floor((easting % 100000) / 100).toString().padStart(3, '0');
      const n100m = Math.floor((northing % 100000) / 100).toString().padStart(3, '0');

      return `${zone}${band} ${col}${row} ${e100m} ${n100m}`;
    }

    // ========= Geo handling =========
    const state = { watchId: null, lat: null, lon: null, acc: null };
    async function checkPermission() {
      try {
        const s = await navigator.permissions.query({ name: 'geolocation' });
        qs('#permState').textContent = s.state;
        s.onchange = () => qs('#permState').textContent = s.state;
      } catch { /* Safari */ }
    }
    function update(lat, lon, acc) {
      state.lat = lat; state.lon = lon; state.acc = acc ?? null;
      qs('#latInput').value = lat.toFixed(6);
      qs('#lonInput').value = lon.toFixed(6);
      qs('#fixState').textContent = acc ? `±${Math.round(acc)} m` : '更新';
      // Lat/Lon formats
      const dd = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      const ddm = `${toDDM(lat, true)} , ${toDDM(lon, false)}`;
      const dms = `${toDMS(lat, true)} , ${toDMS(lon, false)}`;
      const geouri = `geo:${lat.toFixed(6)},${lon.toFixed(6)}${acc ? `?u=${Math.round(acc)}` : ''}`;
      qs('#dd').textContent = dd;
      qs('#ddm').textContent = ddm;
      qs('#dms').textContent = dms;
      qs('#geouri').textContent = geouri;
      // UTM/MGRS
      const utm = latLonToUTM(lat, lon);
      qs('#utm').textContent = `${utm.zone}${utm.hemisphere} ${utm.easting.toFixed(3)} E, ${utm.northing.toFixed(3)} N`;
      qs('#mgrs').textContent = utmToMgrs(lat, utm);
      // OLC
      const olc = olcEncode(lat, lon, 11);
      qs('#olc').textContent = olc;
      qs('#olc8').textContent = olcEncode(lat, lon, 10);
      // copy payloads map
      copyPayload.dd = dd; copyPayload.ddm = ddm; copyPayload.dms = dms; copyPayload.geouri = geouri; copyPayload.utm = qs('#utm').textContent; copyPayload.mgrs = qs('#mgrs').textContent; copyPayload.olc = olc; copyPayload.olc8 = qs('#olc8').textContent;
    }

    const copyPayload = {};
    qsa('.copy').forEach(btn => {
      btn.textContent = 'コピー';
      btn.addEventListener('click', async () => {
        const id = btn.dataset.copy; const text = copyPayload[id];
        if (!text) return;
        try { await navigator.clipboard.writeText(text); btn.textContent = '✓ コピー'; btn.classList.add('ok'); setTimeout(() => { btn.textContent = 'コピー'; btn.classList.remove('ok'); }, 1200); } catch (e) { alert('コピーに失敗しました'); }
      });
    });

    // Events
    qs('#btnLocate').addEventListener('click', () => {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        update(latitude, longitude, accuracy);
        qs('#status').textContent = `取得: lat ${latitude.toFixed(6)}, lon ${longitude.toFixed(6)} (±${Math.round(accuracy)}m)`;
      }, err => {
        qs('#status').textContent = `エラー: ${err.message}`;
        qs('#fixState').textContent = '失敗';
      }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 });
    });

    qs('#btnWatch').addEventListener('click', () => {
      if (state.watchId) return;
      state.watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        update(latitude, longitude, accuracy);
        qs('#fixState').textContent = `追従中 ±${Math.round(accuracy)} m`;
      }, err => {
        qs('#status').textContent = `エラー: ${err.message}`;
      }, { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 });
    });

    qs('#btnStop').addEventListener('click', () => {
      if (state.watchId) { navigator.geolocation.clearWatch(state.watchId); state.watchId = null; qs('#fixState').textContent = '停止'; }
    });

    qs('#btnApply').addEventListener('click', () => {
      const lat = parseFloat(qs('#latInput').value);
      const lon = parseFloat(qs('#lonInput').value);
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        update(lat, lon, null);
        qs('#status').textContent = '手入力で更新しました。';
      } else {
        qs('#status').textContent = '数値を入力してください。';
      }
    });

    checkPermission();
  </script>
</body>

</html>