<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <title>MGRS ã‚°ãƒªãƒƒãƒ‰ç¯„å›²è¨ˆç®—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', ui-sans-serif, system-ui, Segoe UI, Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }

    header {
      padding: 24px 0 10px 0;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: .5px;
    }

    main {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      padding: 0;
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 24px 18px 18px 18px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.10);
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    label {
      display: block;
      font-size: .98rem;
      color: #333;
      margin-bottom: 6px;
      font-weight: 700;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #b0b8c9;
      border-radius: 10px;
      background: #f8fafc;
      color: #222;
      outline: none;
      font-size: 1rem;
      transition: .18s;
      margin-bottom: 0.5rem;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, .08);
    }

    .controls {
      display: flex;
      gap: .75rem;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .3px;
      box-shadow: 0 4px 12px rgba(34, 197, 94, .10);
      font-size: 1rem;
    }

    button.secondary {
      background: #b0b8c9;
      color: #222;
      font-weight: 600;
    }

    .error {
      color: #ef4444;
      margin-top: 10px;
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .kv {
      background: #f8fafc;
      border: 1px solid #e0e7ef;
      border-radius: 10px;
      padding: 12px;
    }

    .muted {
      color: #94a3b8;
      font-size: .88rem;
      margin-bottom: 6px;
    }

    code,
    var {
      background: #e6eef6;
      padding: 2px 6px;
      border-radius: 6px;
      color: #222;
    }

    .footer {
      color: #94a3b8;
      font-size: .85rem;
      margin-top: 12px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    .result-block {
      white-space: pre-wrap;
      word-break: break-word;
      color: #222;
    }

    .value {
      font-size: 1.05rem;
      font-weight: 700;
      color: #222;
      margin-top: 6px;
    }

    .value .accent {
      color: #22c55e;
      font-weight: 800;
    }

    @media (max-width:520px) {
      header h1 {
        font-size: 1.15rem;
      }

      .card {
        padding: 12px 4px 8px 4px;
      }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #121212;
        color: #e0e0e0;
      }

      .card {
        background: #1e1e1e;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
      }

      .kv {
        background: #23272f;
        border: 1px solid #23272f;
      }

      input[type="text"] {
        background: #23272f;
        color: #e0e0e0;
        border: 1px solid #334155;
      }

      input[type="text"]:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, .08);
      }

      button.secondary {
        background: #334155;
        color: #e6eef6;
      }

      code,
      var {
        background: #07111a;
        color: #e0e0e0;
      }

      .result-block {
        color: #e6eef6;
      }

      .value {
        color: #e0e0e0;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>ğŸ—ºï¸ MGRS â†’ ã‚°ãƒªãƒƒãƒ‰ç¯„å›²ï¼ˆSW / NEï¼‰</h1>
    <div class="muted">å…¥åŠ›ã•ã‚ŒãŸ MGRS ã®æ¡æ•°ã‹ã‚‰ã€ã‚»ãƒ«è§£åƒåº¦ã€100km å››è§’å†…ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆmï¼‰ã€ãŠã‚ˆã³å¢ƒç•Œã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
  </header>
  <main>
    <div class="card">
      <label for="mgrsInput">MGRSï¼ˆä¾‹: <code class="mono">54S VE 176 958</code> / <code class="mono">54SUE12</code> /
        <code class="mono">54SUE</code>ï¼‰</label>
      <input id="mgrsInput" type="text" placeholder="54SVE17689580" spellcheck="false" />
      <div class="controls">
        <button id="btnCalc">è¨ˆç®—ã™ã‚‹</button>
        <button id="btnClear" class="secondary">ã‚¯ãƒªã‚¢</button>
        <span id="status" class="muted" aria-live="polite"></span>
      </div>
      <div id="error" class="error" role="alert" aria-live="assertive"></div>
      <div id="out" class="grid" style="margin-top:16px; display:none;">
        <div class="kv">
          <div class="muted">æ­£è¦åŒ– MGRS</div>
          <div id="o_norm" class="mono value"></div>
        </div>
        <div class="kv">
          <div class="muted">è¦ç´ </div>
          <div class="result-block mono" id="o_parts"></div>
        </div>
        <div class="kv">
          <div class="muted">ã‚»ãƒ«è§£åƒåº¦</div>
          <div class="mono value" id="o_res"></div>
        </div>
        <div class="kv">
          <div class="muted">100 km å››è§’å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆmï¼‰</div>
          <div class="result-block mono" id="o_offsets"></div>
        </div>
        <div class="kv" style="grid-column: 1 / -1;">
          <div class="muted">SW / NEï¼ˆMGRS 5æ¡ãƒšã‚¢è¡¨è¨˜ï¼‰</div>
          <div class="result-block mono" id="o_mgrs_bounds"></div>
          <div class="footer">â€» NE ã¯ä¸Šç«¯ï¼ˆæ’ä»–çš„ï¼‰ã§ã™ã€‚100000 ã®å ´åˆã¯å¢ƒç•Œä¸Šã¨ãªã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="kv" style="grid-column: 1 / -1;">
          <div class="muted">å››éš…ï¼ˆç·¯åº¦, çµŒåº¦ / WGS84ï¼‰</div>
          <div class="result-block mono" id="o_latlon_bounds"></div>
          <div class="footer">â€» ç·¯åº¦/çµŒåº¦å¤‰æ›ã¯ mgrs ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œã—ã¾ã™ã€‚</div>
        </div>
        <div class="kv" style="grid-column: 1 / -1;">
          <div class="muted">å¹¾ä½•ä¸­å¿ƒï¼ˆMGRS / ç·¯åº¦, çµŒåº¦ / WGS84ï¼‰</div>
          <div class="result-block mono" id="o_centroid"></div>
        </div>
      </div>
      <div class="footer">
        è£œè¶³ï¼šã“ã“ã§ã¯ 100 km ãƒ¡ãƒƒã‚·ãƒ¥å†…ã®ç›¸å¯¾è·é›¢ï¼ˆmï¼‰ã¨ 5æ¡ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°è¡¨è¨˜ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚åœ°å›³æç”»ã¯è¡Œã„ã¾ã›ã‚“ã€‚
      </div>
    </div>
  </main>
  <footer style="font-size:0.9em; color:#666; text-align:center; padding:10px 0; width:100%; margin-top:24px;">
    &copy; 2025 Iwata M. All rights reserved.
  </footer>

  <!-- ESM import fallback for mgrs (non-critical) -->
  <script type="module">
    (async () => {
      try {
        const mod = await import('https://unpkg.com/mgrs@1.0.0/mgrs.js');
        window.mgrs = (mod && (mod.default || mod.mgrs)) || mod;
        console.info('mgrs loaded via ESM import', !!window.mgrs);
      } catch (e) {
        console.debug('mgrs ESM import failed:', e && e.message ? e.message : e);
      }
    })();
  </script>

  <script>
    // --- Utilities ----------------------------------------------------------
    const $ = sel => document.querySelector(sel);
    const pad5 = n => {
      // Ensure numeric and handle boundary 100000 (exclusive upper bound marker)
      const num = Number(n) || 0;
      if (num >= 100000) return String(num); // allow 100000 as a boundary marker
      const clamped = Math.max(0, Math.min(99999, Math.floor(num)));
      return String(clamped).padStart(5, '0');
    };

    function normalizeInput(str) {
      if (!str) return '';
      // Trim, uppercase and remove any non-alphanumeric characters to normalize inputs like
      // "54S VE 17689 58" or "54S-VE-17689/58" into a compact form.
      return ('' + str).trim().toUpperCase().replace(/[^A-Z0-9]+/g, '');
    }

    function parseMGRS(s) {
      const err = msg => { throw new Error(msg); };
      if (!/^[0-9]{1,2}[C-HJ-NP-X][A-HJ-NP-Z]{2}([0-9]{0,10})$/i.test(s)) {
        err("MGRS å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ä¾‹: 54SUE123456 / 54S UE 12 / 54SUE\næ•°å€¤éƒ¨ã¯ 0,2,4,6,8,10 æ¡ã§ã™ã€‚");
      }
      const m = s.match(/^([0-9]{1,2})([C-HJ-NP-X])([A-HJ-NP-Z]{2})([0-9]*)$/i);
      if (!m) err("è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      const zone = parseInt(m[1], 10);
      if (!(zone >= 1 && zone <= 60)) err("ã‚¾ãƒ¼ãƒ³ç•ªå·ãŒä¸æ­£ã§ã™ (1..60)ã€‚");
      const band = m[2];
      const grid = m[3];
      const nums = m[4] || '';
      const col = grid[0], row = grid[1];
      if (/[IO]/.test(band + col + row)) err("MGRS ã§ã¯ I, O ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚");
      if (nums.length % 2 !== 0 || nums.length > 10) {
        err("æ•°å€¤éƒ¨ã¯ 0,2,4,6,8,10 æ¡ï¼ˆå„åŠåˆ†ãŒåŒã˜æ¡æ•°ï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
      }
      const half = Math.floor(nums.length / 2);
      const eStr = nums.slice(0, half);
      const nStr = nums.slice(half);
      return { zone, band, col, row, eStr, nStr };
    }

    function resolutionForDigits(nEach) {
      if (nEach === 0) return 100000;
      if (nEach === 1) return 10000;
      if (nEach === 2) return 1000;
      if (nEach === 3) return 100;
      if (nEach === 4) return 10;
      if (nEach === 5) return 1;
      throw new Error("ä¸æ­£ãªæ¡æ•°ã§ã™");
    }

    function toFiveDigitPair(e_off_m, n_off_m) {
      // Use floor to coerce floats, allow 100000 as an exclusive upper-bound marker
      const clampVal = v => Math.max(0, Math.min(100000, Math.floor(Number(v) || 0)));
      return { e: pad5(clampVal(e_off_m)), n: pad5(clampVal(n_off_m)) };
    }

    function computeCellBounds(parsed) {
      const { zone, band, col, row, eStr, nStr } = parsed;
      const nEach = eStr.length;
      const res = resolutionForDigits(nEach);
      const eDigits = eStr ? parseInt(eStr, 10) : 0;
      const nDigits = nStr ? parseInt(nStr, 10) : 0;
      const e_off = eDigits * res;
      const n_off = nDigits * res;
      const e_off_NE = e_off + res;
      const n_off_NE = n_off + res;
      const SW = toFiveDigitPair(e_off, n_off);
      const NE = toFiveDigitPair(e_off_NE, n_off_NE);
      return {
        zone, band, col, row,
        resolution_m: res,
        digits_each: nEach,
        easting_m: { min: e_off, max_exclusive: e_off_NE },
        northing_m: { min: n_off, max_exclusive: n_off_NE },
        sw_mgrs_pair: `${SW.e} ${SW.n}`,
        ne_upper_pair: `${NE.e} ${NE.n}`
      };
    }

    function renderResult(result) {
      const { zone, band, col, row, resolution_m, digits_each, easting_m, northing_m, sw_mgrs_pair, ne_upper_pair } = result;

      $('#o_norm').textContent = `${String(zone).padStart(2, '0')}${band}${col}${row}${(digits_each > 0) ? (String(easting_m.min / resolution_m).padStart(digits_each, '0') + String(northing_m.min / resolution_m).padStart(digits_each, '0')) : ''}`;

      $('#o_parts').textContent =
        `ã‚¾ãƒ¼ãƒ³:        ${zone}
ç·¯åº¦å¸¯(Band):  ${band}
100kmå››è§’ID:   ${col}${row}
æ•°å€¤æ¡ (å„è»¸):  ${digits_each}`;

      const humanRes = (m) => { if (m >= 1000) return (m / 1000).toLocaleString() + ' km'; return m.toLocaleString() + ' m'; };
      $('#o_res').textContent = `${humanRes(resolution_m)} / side`;

      $('#o_offsets').textContent =
        `Easting : [${easting_m.min.toLocaleString()} , ${easting_m.max_exclusive.toLocaleString()}) m
Northing: [${northing_m.min.toLocaleString()} , ${northing_m.max_exclusive.toLocaleString()}) m`;

      $('#o_mgrs_bounds').textContent =
        `${String(zone).padStart(2, '0')}${band} ${col}${row}  SW  ${sw_mgrs_pair}
${String(zone).padStart(2, '0')}${band} ${col}${row}  NE  ${ne_upper_pair}  (ä¸Šç«¯ãƒ»æ’ä»–å¢ƒç•Œ)`;

      try {
        if (typeof window.mgrs !== 'undefined' && window.mgrs && typeof window.mgrs.toPoint === 'function') {
          const zStr = String(zone).padStart(2, '0');
          const eMin = easting_m.min | 0;
          const eMaxEx = easting_m.max_exclusive | 0;
          const nMin = northing_m.min | 0;
          const nMaxEx = northing_m.max_exclusive | 0;
          const swE = pad5(eMin);
          const swN = pad5(nMin);
          const seE = pad5(Math.max(0, eMaxEx - 1));
          const seN = pad5(nMin);
          const nwE = pad5(eMin);
          const nwN = pad5(Math.max(0, nMaxEx - 1));
          const neE = pad5(Math.max(0, eMaxEx - 1));
          const neN = pad5(Math.max(0, nMaxEx - 1));
          const fullSw = `${zStr}${band}${col}${row}${swE}${swN}`;
          const fullSe = `${zStr}${band}${col}${row}${seE}${seN}`;
          const fullNw = `${zStr}${band}${col}${row}${nwE}${nwN}`;
          const fullNe = `${zStr}${band}${col}${row}${neE}${neN}`;
          const sw_ll = window.mgrs.toPoint(fullSw);
          const se_ll = window.mgrs.toPoint(fullSe);
          const nw_ll = window.mgrs.toPoint(fullNw);
          const ne_ll = window.mgrs.toPoint(fullNe);
          const fmt = v => Number(v).toFixed(6);
          $('#o_latlon_bounds').textContent =
            `${fmt(nw_ll[1])} , ${fmt(nw_ll[0])}
${fmt(ne_ll[1])} , ${fmt(ne_ll[0])}
${fmt(se_ll[1])} , ${fmt(se_ll[0])}
${fmt(sw_ll[1])} , ${fmt(sw_ll[0])}`;
          // å¹¾ä½•ä¸­å¿ƒï¼ˆã‚»ãƒ«å†…éƒ¨ã®ä¸­å¿ƒç‚¹ï¼‰ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
          try {
            const centerE = easting_m.min + (resolution_m / 2);
            const centerN = northing_m.min + (resolution_m / 2);
            const centerE5 = pad5(Math.round(centerE));
            const centerN5 = pad5(Math.round(centerN));
            const fullCenter = `${zStr}${band}${col}${row}${centerE5}${centerN5}`;
            const center_ll = window.mgrs.toPoint(fullCenter);
            $('#o_centroid').textContent = `${fullCenter}\n${fmt(center_ll[1])} , ${fmt(center_ll[0])}`;
          } catch (ce) {
            $('#o_centroid').textContent = 'ä¸­å¿ƒç‚¹è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (ce && ce.message ? ce.message : ce);
          }
        } else {
          $('#o_latlon_bounds').textContent = 'ç·¯åº¦/çµŒåº¦å¤‰æ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
          $('#o_centroid').textContent = 'ç·¯åº¦/çµŒåº¦å¤‰æ›ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
        }
      } catch (err) {
        $('#o_latlon_bounds').textContent = 'ç·¯åº¦/çµŒåº¦å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err);
      }

      $('#out').style.display = 'grid';
    }

    function waitForMgrs(timeoutMs = 2000, intervalMs = 50) {
      return new Promise(resolve => {
        if (typeof window.mgrs !== 'undefined' && window.mgrs && typeof window.mgrs.toPoint === 'function') return resolve(true);
        const start = Date.now();
        const id = setInterval(() => {
          if (typeof window.mgrs !== 'undefined' && window.mgrs && typeof window.mgrs.toPoint === 'function') {
            clearInterval(id); resolve(true);
          } else if (Date.now() - start > timeoutMs) {
            clearInterval(id); resolve(false);
          }
        }, intervalMs);
      });
    }

    async function onCalculate() {
      $('#error').textContent = '';
      $('#status').textContent = 'è¨ˆç®—ä¸­â€¦';
      try {
        const raw = $('#mgrsInput') ? $('#mgrsInput').value : '';
        const norm = normalizeInput(raw);
        $('#mgrsInput').value = norm;
        const parsed = parseMGRS(norm);
        const result = computeCellBounds(parsed);
        await waitForMgrs(2000, 50);
        renderResult(result);
        $('#status').textContent = 'å®Œäº†';
      } catch (e) {
        $('#out').style.display = 'none';
        $('#status').textContent = '';
        $('#error').textContent = e.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#btnCalc').addEventListener('click', onCalculate);
      $('#btnClear').addEventListener('click', () => {
        $('#mgrsInput').value = ''; $('#out').style.display = 'none'; $('#error').textContent = ''; $('#status').textContent = '';
        $('#mgrsInput').focus();
      });
      $('#mgrsInput').addEventListener('keydown', e => { if (e.key === 'Enter') { onCalculate(); } });
    });
  </script>
</body>

</html>