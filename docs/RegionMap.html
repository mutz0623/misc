<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åœ°å›³ç¯„å›²å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ï¼ˆå¤šè§’å½¢ãƒ»å†† / åº§æ¨™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œï¼‰</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root {
      --bg: #f4f4f9;
      --panel: #fff;
      --muted: #666;
      --text: #333;
      --accent: #007BFF;
      --danger: #ef4444;
      --ok: #10b981
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --panel: #1e1e1e;
        --muted: #999;
        --text: #e0e0e0;
        --accent: #80bfff;
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Roboto', sans-serif
    }

    .app {
      display: grid;
      grid-template-columns: 380px 1fr;
      grid-template-rows: 100vh;
      gap: 0;
      transition: all 0.3s ease
    }

    .app.sidebar-collapsed {
      grid-template-columns: 50px 1fr
    }

    .sidebar {
      background: var(--panel);
      border-right: 1px solid rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: auto;
      box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative
    }

    .sidebar.collapsed {
      padding: 15px 10px;
      width: 50px;
      overflow: hidden;
      white-space: nowrap
    }

    .sidebar.collapsed>* {
      display: none
    }

    .sidebar.collapsed .toggle-sidebar {
      display: flex !important
    }

    .toggle-sidebar {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      background: transparent;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text);
      font-size: 16px;
      transition: all 0.3s ease;
      padding: 0;
      margin-bottom: 10px;
      flex-shrink: 0
    }

    .toggle-sidebar:hover {
      background: var(--accent);
      color: var(--panel);
      border-color: var(--accent)
    }

    @media (prefers-color-scheme: dark) {
      .toggle-sidebar {
        border-color: rgba(255, 255, 255, 0.2)
      }

      .toggle-sidebar:hover {
        background: var(--accent);
        color: var(--panel)
      }
    }

    @media (prefers-color-scheme: dark) {
      .sidebar {
        border-right-color: rgba(255, 255, 255, 0.1);
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.5)
      }
    }

    h1 {
      font-size: 20px;
      margin: 0 0 15px;
      letter-spacing: .2px;
      font-weight: 700;
      color: var(--text)
    }

    .sub {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.3s ease;
      font-family: 'Roboto', sans-serif
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent)
    }

    textarea {
      min-height: 110px;
      resize: vertical;
      line-height: 1.4
    }

    @media (prefers-color-scheme: dark) {

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2)
      }
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      font-weight: 700
    }

    .btn.icon {
      padding: 8px;
      font-size: 14px
    }

    .btn:hover {
      background: var(--accent);
      color: var(--panel)
    }

    .btn.primary {
      background: var(--accent);
      color: var(--panel);
      font-weight: 700
    }

    .btn.primary:hover {
      opacity: 0.9
    }

    .btn.ghost {
      background: transparent;
      border-color: rgba(0, 0, 0, 0.2)
    }

    .btn.danger {
      border-color: var(--danger);
      color: var(--danger)
    }

    .btn.danger:hover {
      background: var(--danger);
      color: var(--panel)
    }

    @media (prefers-color-scheme: dark) {
      .btn.ghost {
        border-color: rgba(255, 255, 255, 0.2)
      }
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-top: 12px
    }

    .card {
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 20px;
      background: var(--panel);
      margin: 15px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1)
    }

    @media (prefers-color-scheme: dark) {
      .card {
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5)
      }
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .item {
      padding: 15px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      background: var(--panel);
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
    }

    @media (prefers-color-scheme: dark) {
      .item {
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3)
      }
    }

    .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid #0006
    }

    .item-header {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .item-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      padding: 2px 0
    }

    .grow {
      flex: 1
    }

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    .success {
      color: var(--ok);
      font-size: 12px
    }

    .err {
      color: #fecaca;
      background: #3b0f13;
      border: 1px solid #7f1d1d;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      margin-top: 10px;
      white-space: pre-wrap
    }

    #map {
      height: 100%;
      width: 100%
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.4
    }

    .small {
      font-size: 11px
    }

    .kbd {
      display: inline-block;
      padding: 0 6px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-bottom-width: 2px;
      border-radius: 6px;
      background: var(--panel);
      color: var(--text);
      font-size: 11px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1)
    }

    @media (prefers-color-scheme: dark) {
      .kbd {
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3)
      }
    }

    .section-title {
      font-weight: 600;
      font-size: 13px;
      letter-spacing: .2px;
      margin-top: 8px
    }

    .leaflet-tooltip.label {
      background: rgba(0, 0, 0, .55);
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 11px;
      box-shadow: none;
      margin-top: -25px;
      white-space: nowrap;
    }

    .coords-panel {
      margin-top: 8px;
      padding: 12px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
    }

    @media (prefers-color-scheme: dark) {
      .coords-panel {
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3)
      }
    }

    .coords-lines {
      max-height: 160px;
      overflow: auto;
      margin-bottom: 12px;
      padding: 8px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.6;
      word-break: break-all;
      word-wrap: break-word;
      background: var(--panel);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px
    }

    @media (prefers-color-scheme: dark) {
      .coords-lines {
        border-color: rgba(255, 255, 255, 0.1)
      }
    }

    .coords-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end
    }

    .coords-actions .btn {
      font-size: 12px;
      padding: 6px 12px
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <button class="toggle-sidebar" id="toggle-sidebar-btn" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€">â—€</button>
      <h1>åœ°å›³ç¯„å›²å¯è¦–åŒ–</h1>
      <div class="sub">å¤šè§’å½¢/å††ã‚’è¤‡æ•°è¿½åŠ ãƒ»è¡¨ç¤ºã€‚åº§æ¨™ã¯ <b>åº¦-åˆ†-ç§’</b>ãƒ»<b>å°æ•°</b>ãƒ»<b>å…¨è§’</b>ãƒ»<b>æ—¥æœ¬èªè¡¨è¨˜</b>ã«ã‚‚å¯¾å¿œã€‚</div>

      <div class="card" id="form-card">
        <div class="row">
          <div>
            <label>ç¨®é¡</label>
            <select id="geom-type" aria-label="åœ°å›³ç¯„å›²ã®ç¨®é¡ã‚’é¸æŠ">
              <option value="polygon">å¤šè§’å½¢</option>
              <option value="circle">å††ï¼ˆä¸­å¿ƒï¼‹åŠå¾„ï¼‰</option>
            </select>
          </div>
          <div>
            <label>åç§°ï¼ˆä»»æ„ï¼‰</label>
            <input id="geom-name" type="text" placeholder="ä¾‹ï¼šã‚¨ãƒªã‚¢A" aria-label="åœ°å›³ç¯„å›²ã®åç§°" />
          </div>
        </div>

        <div id="polygon-fields">
          <label>é ‚ç‚¹åº§æ¨™ï¼ˆ1è¡Œ=1ç‚¹ï¼‰</label>
          <textarea id="polygon-input" placeholder="ä¾‹ï¼š
30-25-40N 130-58-21E
30-26-24N 130-59-22E
30-26-24N 131-16-48E
30-16-12N 131-16-48E
30-16-12N 130-57-49E
30-21-57N 130-57-49E
30-22-20N 130-57-41E" aria-label="å¤šè§’å½¢ã®é ‚ç‚¹åº§æ¨™"></textarea>
          <div class="hint">
            <div class="small">ãƒ»<span class="kbd">25-09N 132-13E</span>ï¼ˆå…¨è§’/åŠè§’ã©ã¡ã‚‰ã§ã‚‚ï¼‰</div>
            <div class="small">ãƒ»<span class="kbd">N34-59.1-E139-05.8</span>ï¼ˆåˆ†ã®å°æ•°ç‚¹ï¼‰</div>
            <div class="small">ãƒ»<span class="kbd">25Â°09' N 132Â°13' E</span> / <span class="kbd">25 09 N 132 13 E</span>
            </div>
            <div class="small">ãƒ»<span class="kbd">25.15, 132.2167</span>ï¼ˆå°æ•°, ç·¯åº¦,çµŒåº¦ï¼‰</div>
            <div class="small">ãƒ»<span class="kbd">åŒ—ç·¯34åº¦35åˆ†12ç§’ æ±çµŒ140åº¦16åˆ†48ç§’</span>ï¼ˆæ—¥æœ¬èªï¼‰</div>
          </div>
        </div>

        <div id="circle-fields" style="display:none">
          <label>ä¸­å¿ƒåº§æ¨™</label>
          <input id="circle-center" type="text"
            placeholder="ä¾‹ï¼šï¼’ï¼•ï¼ï¼ï¼™ï¼® ï¼‘ï¼“ï¼’ï¼ï¼‘ï¼“ï¼¥ / åŒ—ç·¯34åº¦35åˆ†12ç§’ æ±çµŒ140åº¦16åˆ†48ç§’ / 25.15,132.2167" aria-label="å††ã®ä¸­å¿ƒåº§æ¨™" />
          <div class="row">
            <div>
              <label>åŠå¾„</label>
              <input id="circle-radius" type="number" min="0" step="0.001" placeholder="æ•°å€¤" aria-label="å††ã®åŠå¾„" />
            </div>
            <div>
              <label>å˜ä½</label>
              <select id="circle-unit" aria-label="å††ã®åŠå¾„ã®å˜ä½">
                <option value="m">m</option>
                <option value="km" selected>km</option>
                <option value="nm">NMï¼ˆæµ·é‡Œï¼‰</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>æ–¹è§’ï¼ˆä¸­å¿ƒè§’åº¦, 0=åŒ—, æ™‚è¨ˆå›ã‚Š, Â°ï¼‰</label>
              <input id="circle-direction" type="number" min="0" max="360" step="0.1" placeholder="ä¾‹: 45"
                aria-label="æ‰‡å‹ã®ä¸­å¿ƒæ–¹è§’" />
            </div>
            <div>
              <label>ç¯„å›²ï¼ˆè§’åº¦, Â°ï¼‰</label>
              <input id="circle-sector-angle" type="number" min="0" max="360" step="0.1" placeholder="ä¾‹: 60"
                aria-label="æ‰‡å‹ã®è§’åº¦ç¯„å›²" />
            </div>
          </div>
          <div class="hint small">æ–¹è§’ãƒ»ç¯„å›²ã‚’æŒ‡å®šã™ã‚‹ã¨æ‰‡å‹ï¼ˆã‚»ã‚¯ã‚¿ãƒ¼ï¼‰ã‚’æç”»ã—ã¾ã™ã€‚ç©ºæ¬„ãªã‚‰å††å…¨ä½“ã€‚</div>
        </div>

        <div class="toolbar">
          <button id="add-geom" class="btn primary" aria-label="åœ°å›³ç¯„å›²ã‚’è¿½åŠ ">é ˜åŸŸã‚’è¿½åŠ </button>
          <button id="fit-all" class="btn ghost" title="ã™ã¹ã¦ã®é ˜åŸŸã‚’åã‚ã‚‹" aria-label="ã™ã¹ã¦ã®é ˜åŸŸã‚’åœ°å›³ã«è¡¨ç¤º">å…¨ä½“è¡¨ç¤º</button>
        </div>
        <div id="error" class="err" style="display:none"></div>
        <div id="ok" class="success" style="display:none">è¿½åŠ ã—ã¾ã—ãŸã€‚</div>
      </div>

      <div class="card">
        <div class="section-title">é ˜åŸŸä¸€è¦§</div>
        <div id="list" class="list"></div>
        <div class="hint small">ãƒ’ãƒ³ãƒˆï¼š
          <span class="kbd">ğŸ‘ï¸/ğŸ‘ï¸â€ğŸ—¨ï¸</span>ã§è¡¨ç¤º/éè¡¨ç¤ºã€<span class="kbd">âœï¸</span>ã§åç§°ç·¨é›†ã€<span class="kbd">ğŸ—‘</span>ã§å‰Šé™¤ã€‚
        </div>
      </div>

      <div class="card">
        <div class="section-title">åº§æ¨™å…¥åŠ›ã®ã‚³ãƒ„</div>
        <div class="hint small">
          ãƒ»å…¨è§’ã®æ•°å­—/è¨˜å·/æ–¹ä½ï¼ˆï¼®ï¼¥ï¼³ï¼·ï¼‰ã§ã‚‚OKã§ã™ã€‚<br />
          ãƒ»<b>åº¦-åˆ†-ç§’</b> ã¾ã§æ›¸ã„ã¦ã‚‚OKï¼ˆä¾‹ï¼š<span class="kbd">35-39-29N</span>ï¼‰ã€‚<br />
          ãƒ»<b>æ—¥æœ¬èªè¡¨è¨˜</b>ã«ã‚‚å¯¾å¿œï¼ˆä¾‹ï¼š<span class="kbd">åŒ—ç·¯34åº¦35åˆ†12ç§’ æ±çµŒ140åº¦16åˆ†48ç§’</span>ï¼‰ã€‚<br />
          ãƒ»<b>åˆ†ã®å°æ•°ç‚¹</b>ã«ã‚‚å¯¾å¿œï¼ˆä¾‹ï¼š<span class="kbd">åŒ—ç·¯34åº¦59.1åˆ† æ±çµŒ139åº¦05.8åˆ†</span>ï¼‰ã€‚<br />
          ãƒ»æ–¹ä½ãŒãªã„å ´åˆã¯ <b>ç·¯åº¦,çµŒåº¦</b> ã®é †ã¨ã—ã¦è§£é‡ˆã—ã¾ã™ï¼ˆå—/è¥¿ã¯ãƒã‚¤ãƒŠã‚¹ï¼‰ã€‚
        </div>
      </div>
      <!-- è‘—ä½œæ¨©è¡¨ç¤º -->
      <div style="text-align:center; color:#94a3b8; font-size:11px; margin-top:16px;">
        &copy; 2025 Iwata M. All rights reserved.
      </div>
    </aside>
    <main id="map"></main>
  </div>

  <script>
    // =============================
    //  ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
    // =============================
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    const sidebar = document.querySelector('.sidebar');
    const app = document.querySelector('.app');
    let isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

    function updateSidebarState() {
      if (isCollapsed) {
        sidebar.classList.add('collapsed');
        app.classList.add('sidebar-collapsed');
        toggleSidebarBtn.textContent = 'â–¶';
        toggleSidebarBtn.title = 'ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å±•é–‹ã™ã‚‹';
      } else {
        sidebar.classList.remove('collapsed');
        app.classList.remove('sidebar-collapsed');
        toggleSidebarBtn.textContent = 'â—€';
        toggleSidebarBtn.title = 'ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€';
      }
      localStorage.setItem('sidebarCollapsed', isCollapsed);
      // Leaflet ã® map resize event ã‚’ç™ºç«ã•ã›ã‚‹
      setTimeout(() => map.invalidateSize(), 300);
    }

    toggleSidebarBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      updateSidebarState();
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    updateSidebarState();
    const ZEN2HAN_MAP = {
      'ï¼': '0', 'ï¼‘': '1', 'ï¼’': '2', 'ï¼“': '3', 'ï¼”': '4', 'ï¼•': '5', 'ï¼–': '6', 'ï¼—': '7', 'ï¼˜': '8', 'ï¼™': '9',
      'ï¼': '-', 'ãƒ¼': '-', 'â€”': '-', 'â€•': '-', '-': '-', 'â€“': '-', 'âˆ’': '-',
      'ã€€': ' ', 'ï¼Œ': ',', 'ï¼': '.', 'ï¼š': ':', 'ï¼›': ';', 'ï¼': '/', 'ï¼ˆ': '(', 'ï¼‰': ')', 'ï¼‹': '+', 'ï¼Š': '*', 'â€™': '\'', 'â€³': '\"',
      'ï¼®': 'N', 'ï¼³': 'S', 'ï¼¥': 'E', 'ï¼·': 'W', 'ï½': 'N', 'ï½“': 'S', 'ï½…': 'E', 'ï½—': 'W',
      'Â°': 'Â°', 'â€²': '\'', 'â€œ': '\"', 'â€': '\"'
    };
    function toHalfWidth(str) { return (str || '').split('').map(ch => ZEN2HAN_MAP[ch] ?? ch).join(''); }
    function normalizeCoordString(s) {
      s = toHalfWidth(s).trim();
      // æ—¥æœ¬èª â†’ è‹±å­—ï¼‹DMSè¨˜å·
      // æ—¥æœ¬èªè¡¨è¨˜ã‚’è‹±å­—ã«å¤‰æ›ï¼ˆå‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è€ƒæ…®ï¼‰
      s = s.replace(/åŒ—ç·¯\s*/gi, 'N')
        .replace(/å—ç·¯\s*/gi, 'S')
        .replace(/æ±çµŒ\s*/gi, 'E')
        .replace(/è¥¿çµŒ\s*/gi, 'W')
        .replace(/(\s*)åŒ—(\s*)/gi, '$1N$2')
        .replace(/(\s*)å—(\s*)/gi, '$1S$2')
        .replace(/(\s*)æ±(\s*)/gi, '$1E$2')
        .replace(/(\s*)è¥¿(\s*)/gi, '$1W$2')
        .replace(/åº¦/gi, '-')
        .replace(/åˆ†/gi, '-')
        .replace(/ç§’/gi, '')  // ç§’ã¯æœ«å°¾ãªã®ã§å‰Šé™¤
        .replace(/ã€/g, ',');
      // DMS è¨˜å·ã‚’ãƒã‚¤ãƒ•ãƒ³åŒ–
      s = s.replace(/[Â°]/g, '-').replace(/[â€²']/g, '-').replace(/[â€³"]/g, '-');
      s = s.replace(/[,\s]+/g, ' ').replace(/[â€“â€”â€•]/g, '-');
      s = s.replace(/\s*-\s*/g, '-').replace(/-+/g, '-').replace(/\s+/g, ' ').trim();
      return s;
    }

    // 1è¦ç´ ã‚’10é€²åº¦ã«
    function parseDMS(token, isLat = null) {
      if (!token) throw new Error('ç©ºã®åº§æ¨™ãƒˆãƒ¼ã‚¯ãƒ³');
      token = normalizeCoordString(token);
      // æ–¹ä½ï¼ˆæœ«å°¾ã¾ãŸã¯å…ˆé ­ï¼‰
      const hemiMatch = token.match(/([NSEW])$/i) || token.match(/^([NSEW])/i);
      let hemi = hemiMatch ? hemiMatch[1].toUpperCase() : null;
      token = token.replace(/^[NSEW]|[NSEW]$/ig, '').trim();

      const parts = token.split(/[-\s]+/).filter(Boolean);
      let deg = 0, min = 0, sec = 0;
      if (parts.length === 1) { deg = parseFloat(parts[0]); }
      else if (parts.length === 2) {
        deg = parseFloat(parts[0]);
        // åˆ†ã®å°æ•°ç‚¹å¯¾å¿œ
        const minParts = parts[1].split('.');
        min = parseFloat(parts[1]);
        if (minParts.length > 1) {
          sec = parseFloat('0.' + minParts[1]) * 60;
        }
      }
      else { deg = parseFloat(parts[0]); min = parseFloat(parts[1]); sec = parseFloat(parts[2] || 0); }
      if ([deg, min, sec].some(v => Number.isNaN(v))) throw new Error('æ•°å€¤ã¨ã—ã¦è§£é‡ˆã§ãã¾ã›ã‚“: ' + token);
      let val = Math.abs(deg) + (Math.abs(min) || 0) / 60 + (Math.abs(sec) || 0) / 3600;
      if (hemi) { if (hemi === 'S' || hemi === 'W') val *= -1; }
      else { if (/^\s*-/.test(token)) val *= -1; }
      if (isLat === true && (val > 90 || val < -90)) throw new Error('ç·¯åº¦ã®ç¯„å›²å¤–');
      if (isLat === false && (val > 180 || val < -180)) throw new Error('çµŒåº¦ã®ç¯„å›²å¤–');
      return val;
    }

    // 1è¡Œã‚’ (lat, lon)
    function parseLatLon(line) {
      line = normalizeCoordString(line);
      if (!line) throw new Error('ç©ºè¡Œ');
      // N34-59.1-E139-05.8- ã®ã‚ˆã†ãªå½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
      const nsewPattern = /^([NS])(\d+[-\d.]+)[-\s]*([EW])(\d+[-\d.]+)-?$/i;
      const nsewMatch = line.match(nsewPattern);
      if (nsewMatch) {
        const [_, nsHemi, latPart, ewHemi, lonPart] = nsewMatch;
        return [
          parseDMS(nsHemi + latPart, true),
          parseDMS(ewHemi + lonPart, false)
        ];
      }

      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå„ªå…ˆ
      let tokens = line.split(',');
      if (tokens.length === 2) { return [parseDMS(tokens[0], true), parseDMS(tokens[1], false)]; }
      // ã‚¹ãƒšãƒ¼ã‚¹åˆ†å‰²
      tokens = line.split(/\s+/).filter(Boolean);
      if (tokens.length === 2) { return [parseDMS(tokens[0], true), parseDMS(tokens[1], false)]; }
      if (tokens.length === 3) { return [parseDMS(tokens[0], true), parseDMS(tokens.slice(1).join(' '), false)]; }
      if (tokens.length >= 4) {
        const idxNS = tokens.findIndex(t => /^([NS])$/i.test(toHalfWidth(t)));
        const idxEW = tokens.findIndex(t => /^([EW])$/i.test(toHalfWidth(t)));
        if (idxNS !== -1 && idxEW !== -1) {
          const latTokens = tokens.slice(0, idxNS + 1).join(' ');
          const lonTokens = tokens.slice(idxNS + 1).join(' ');
          return [parseDMS(latTokens, true), parseDMS(lonTokens, false)];
        } else {
          const half = Math.floor(tokens.length / 2);
          return [parseDMS(tokens.slice(0, half).join(' '), true), parseDMS(tokens.slice(half).join(' '), false)];
        }
      }
      throw new Error('åº§æ¨™è¡Œã®å½¢å¼ã‚’è§£é‡ˆã§ãã¾ã›ã‚“: ' + line);
    }

    // =============================
    //  Leaflet åˆæœŸåŒ–
    // =============================
    const map = L.map('map', { zoomControl: true }).setView([35.68, 139.76], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // =============================
    //  çŠ¶æ…‹
    // =============================
    let NEXT_ID = 1;
    const palette = ['#22d3ee', '#a78bfa', '#f472b6', '#34d399', '#f59e0b', '#60a5fa', '#f43f5e', '#10b981', '#eab308', '#fb7185'];
    function pickColor(idx) { return palette[idx % palette.length]; }
    const regions = new Map();

    // =============================
    //  UI è¦ç´ 
    // =============================
    const elType = document.getElementById('geom-type');
    const elName = document.getElementById('geom-name');
    const elPolyArea = document.getElementById('polygon-fields');
    const elPoly = document.getElementById('polygon-input');
    const elCircleArea = document.getElementById('circle-fields');
    const elCenter = document.getElementById('circle-center');
    const elRadius = document.getElementById('circle-radius');
    const elUnit = document.getElementById('circle-unit');
    const elList = document.getElementById('list');
    const elErr = document.getElementById('error');
    const elOK = document.getElementById('ok');

    elType.addEventListener('change', () => {
      const isPoly = elType.value === 'polygon';
      elPolyArea.style.display = isPoly ? '' : 'none';
      elCircleArea.style.display = isPoly ? 'none' : '';
    });

    function showError(msg) { elErr.style.display = 'block'; elErr.textContent = msg; elOK.style.display = 'none'; }
    function showOK(msg = 'è¿½åŠ ã—ã¾ã—ãŸã€‚') { elErr.style.display = 'none'; elOK.style.display = 'block'; elOK.textContent = msg; setTimeout(() => { elOK.style.display = 'none'; }, 1800); }

    function metersFromUnit(value, unit) {
      const v = Number(value); if (!(v >= 0)) throw new Error('åŠå¾„ãŒä¸æ­£ã§ã™');
      if (unit === 'km') return v * 1000; if (unit === 'nm') return v * 1852; return v;
    }

    function fitAll() {
      const layers = Array.from(regions.values()).map(r => r.layer).filter(l => l && map.hasLayer(l));
      if (!layers.length) { map.setView([35.68, 139.76], 5); return; }
      const group = L.featureGroup(layers);
      map.fitBounds(group.getBounds().pad(0.15));
    }

    function renderList() {
      elList.innerHTML = '';
      if (regions.size === 0) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'ï¼ˆé ˜åŸŸã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰';
        elList.appendChild(empty);
        return;
      }
      Array.from(regions.values()).sort((a, b) => a.id - b.id).forEach(r => {
        const item = document.createElement('div');
        item.className = 'item';

        // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆé ˜åŸŸåã¨ã‚«ãƒ©ãƒ¼ï¼‰
        const header = document.createElement('div');
        header.className = 'item-header';

        const sw = document.createElement('div');
        sw.className = 'swatch';
        sw.style.background = r.color;
        header.appendChild(sw);

        const name = document.createElement('div');
        name.className = 'grow';
        const displayName = r.name && r.name.length ? r.name : (r.type === 'polygon' ? `å¤šè§’å½¢` : `å††`);
        name.innerHTML = `<div><span class="area-name">${displayName}</span> <span class="muted">#${r.id}</span></div>`;
        header.appendChild(name);

        item.appendChild(header);

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³éƒ¨åˆ†ï¼ˆãƒœã‚¿ãƒ³ç¾¤ï¼‰
        const buttonRow = document.createElement('div');
        buttonRow.className = 'item-actions';

        const edit = document.createElement('button');
        edit.className = 'btn icon'; edit.title = 'åç§°ã‚’å¤‰æ›´'; edit.textContent = 'âœï¸';
        edit.addEventListener('click', () => {
          const current = r.name || '';
          const next = window.prompt('é ˜åŸŸåã‚’å…¥åŠ›ï¼ˆç©ºã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåï¼‰', current);
          if (next === null) return;
          r.name = (next || '').trim();
          const label = r.name && r.name.length ? r.name : (r.type === 'polygon' ? `å¤šè§’å½¢` : `å††`);
          r.layer.unbindTooltip();
          r.layer.bindTooltip(`${label} #${r.id}`, { permanent: true, direction: 'center', className: 'label' });
          renderList();
        });
        buttonRow.appendChild(edit);

        const coordsBtn = document.createElement('button');
        coordsBtn.className = 'btn icon'; coordsBtn.title = 'åº§æ¨™ã‚’è¡¨ç¤º'; coordsBtn.textContent = 'ğŸ“';
        buttonRow.appendChild(coordsBtn);

        const toggle = document.createElement('button');
        toggle.className = 'btn icon';
        toggle.title = map.hasLayer(r.layer) ? 'éè¡¨ç¤ºã«ã™ã‚‹' : 'è¡¨ç¤ºã™ã‚‹';
        toggle.innerHTML = map.hasLayer(r.layer) ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggle.addEventListener('click', () => {
          if (map.hasLayer(r.layer)) {
            // remove the main shape
            map.removeLayer(r.layer);
            // also remove any associated markers (ä¾‹ï¼šå††ã®ä¸­å¿ƒç‚¹)
            if (r.markers && r.markers.length) {
              r.markers.forEach(m => { try { if (map.hasLayer(m)) map.removeLayer(m); } catch (e) { } });
            }
            toggle.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
            toggle.title = 'è¡¨ç¤ºã™ã‚‹';
          } else {
            // add the main shape
            r.layer.addTo(map);
            // re-add any markers that belong to this region
            if (r.markers && r.markers.length) {
              r.markers.forEach(m => { try { if (!map.hasLayer(m)) m.addTo(map); } catch (e) { } });
            }
            toggle.innerHTML = 'ğŸ‘ï¸';
            toggle.title = 'éè¡¨ç¤ºã«ã™ã‚‹';
          }
        });
        buttonRow.appendChild(toggle);

        const zoom = document.createElement('button');
        zoom.className = 'btn icon'; zoom.textContent = 'ğŸ”'; zoom.title = 'ã“ã®é ˜åŸŸã«ã‚ºãƒ¼ãƒ ';
        zoom.addEventListener('click', () => {
          if (r.type === 'polygon') map.fitBounds(r.layer.getBounds().pad(0.2));
          else map.fitBounds(r.layer.getBounds().pad(0.6));
        });
        buttonRow.appendChild(zoom);

        const del = document.createElement('button');
        del.className = 'btn danger icon'; del.textContent = 'ğŸ—‘'; del.title = 'å‰Šé™¤';
        del.addEventListener('click', () => {
          // clear any markers belonging to this region
          clearRegionMarkers(r);
          if (map.hasLayer(r.layer)) map.removeLayer(r.layer);
          regions.delete(r.id);
          renderList();
        });
        buttonRow.appendChild(del);
        item.appendChild(buttonRow);

        // details panel for coordinates + actions
        const panel = document.createElement('div');
        panel.className = 'coords-panel';
        panel.style.display = 'none';
        const lines = document.createElement('div'); lines.className = 'coords-lines';
        panel.appendChild(lines);
        // polygon ã®ã¿ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º/è§£é™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        let actions;
        if (r.type === 'polygon') {
          actions = document.createElement('div'); actions.className = 'coords-actions';
          const showMarkersBtn = document.createElement('button'); showMarkersBtn.className = 'btn'; showMarkersBtn.textContent = 'ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º';
          const clearMarkersBtn = document.createElement('button'); clearMarkersBtn.className = 'btn ghost'; clearMarkersBtn.textContent = 'ãƒãƒ¼ã‚«ãƒ¼è§£é™¤';
          actions.appendChild(showMarkersBtn); actions.appendChild(clearMarkersBtn);
          panel.appendChild(actions);
          showMarkersBtn.addEventListener('click', () => { showRegionMarkers(r); });
          clearMarkersBtn.addEventListener('click', () => { clearRegionMarkers(r); });
        }
        item.appendChild(panel);

        coordsBtn.addEventListener('click', () => {
          // toggle panel
          panel.style.display = panel.style.display === 'none' ? '' : 'none';
          if (panel.style.display !== 'none') {
            // populate
            if (r.type === 'polygon') {
              const latlngs = r.layer.getLatLngs();
              // Leaflet polygon can be nested arrays; flatten first ring
              const pts = (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs).map(p => [p.lat, p.lng]);
              lines.textContent = pts.map((p, i) => `${i + 1}. ${formatLatLon(p[0], p[1])}`).join('\n');
            } else if (r.type === 'circle') {
              const c = r.layer.getLatLng();
              const rad = r.layer.getRadius();
              lines.textContent = `ä¸­å¿ƒ: ${formatLatLon(c.lat, c.lng)}\nåŠå¾„(m): ${Math.round(rad)}`;
            }
          }
        });

        elList.appendChild(item);
      });
    }

    function addPolygon() {
      const raw = elPoly.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
      if (raw.length < 3) throw new Error('å¤šè§’å½¢ã¯3ç‚¹ä»¥ä¸ŠãŒå¿…è¦ã§ã™');
      const latlngs = raw.map((ln, i) => {
        try {
          const [lat, lon] = parseLatLon(ln);
          return [lat, lon];
        } catch (e) { throw new Error(`è¡Œ${i + 1}: ${e.message}`); }
      });
      const id = NEXT_ID++;
      const color = pickColor(id);
      const name = elName.value.trim();
      const layer = L.polygon(latlngs, { color, weight: 2, opacity: 0.9, fillOpacity: 0.15 });
      layer.addTo(map);
      const label = name && name.length ? name : 'å¤šè§’å½¢';
      layer.bindTooltip(`${label} #${id}`, { permanent: true, direction: 'top', offset: [0, -10], className: 'label' });
      regions.set(id, { id, type: 'polygon', name, color, layer, markers: [] });
      renderList();
      fitAll();
    }

    function addCircle() {
      const centerText = elCenter.value.trim();
      if (!centerText) throw new Error('ä¸­å¿ƒåº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      const [lat, lon] = parseLatLon(centerText);
      const radiusMeters = metersFromUnit(elRadius.value, elUnit.value);
      if (!(radiusMeters > 0)) throw new Error('åŠå¾„ã¯æ­£ã®å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      const dirVal = document.getElementById('circle-direction').value.trim();
      const sectorVal = document.getElementById('circle-sector-angle').value.trim();
      const id = NEXT_ID++;
      const color = pickColor(id);
      const name = elName.value.trim();
      let layer;
      if (dirVal && sectorVal) {
        // æ‰‡å‹ï¼ˆã‚»ã‚¯ã‚¿ãƒ¼ï¼‰
        const direction = parseFloat(dirVal);
        const sectorAngle = parseFloat(sectorVal);
        if (isNaN(direction) || isNaN(sectorAngle) || sectorAngle <= 0 || sectorAngle > 360)
          throw new Error('ç¯„å›²ï¼ˆè§’åº¦ï¼‰ã¯1ï½360ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        // 0åº¦=åŒ—, æ™‚è¨ˆå›ã‚Š
        const points = [];
        const steps = Math.max(12, Math.ceil(sectorAngle / 5));
        const startAngle = ((direction - sectorAngle / 2) + 360) % 360;
        const endAngle = ((direction + sectorAngle / 2) + 360) % 360;
        points.push([lat, lon]); // ä¸­å¿ƒ
        for (let i = 0; i <= steps; i++) {
          // è§’åº¦ã‚’0=åŒ—, æ™‚è¨ˆå›ã‚Šã§è¨ˆç®—
          let ang = (startAngle + (sectorAngle * i / steps)) % 360;
          // 0Â°=åŒ— â†’ dLatå¢—åŠ , dLng=0
          // 90Â°=æ± â†’ dLat=0, dLngå¢—åŠ 
          // 180Â°=å— â†’ dLatæ¸›å°‘, dLng=0
          // 270Â°=è¥¿ â†’ dLat=0, dLngæ¸›å°‘
          let radians = ang * Math.PI / 180;
          let dLat = (radiusMeters / 6378137) * Math.cos(radians);
          let dLng = (radiusMeters / 6378137) * Math.sin(radians) / Math.cos(lat * Math.PI / 180);
          let plat = lat + dLat * 180 / Math.PI;
          let plon = lon + dLng * 180 / Math.PI;
          points.push([plat, plon]);
        }
        points.push([lat, lon]); // é–‰ã˜ã‚‹
        layer = L.polygon(points, { color, weight: 2, opacity: 0.9, fillOpacity: 0.15 });
      } else {
        // é€šå¸¸ã®å††
        layer = L.circle([lat, lon], { radius: radiusMeters, color, weight: 2, opacity: 0.9, fillOpacity: 0.12 });
      }
      layer.addTo(map);
      // å††ã®ä¸­å¿ƒç‚¹ã‚’å¸¸ã«è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆã—ã¦ãŠã
      const centerMarker = L.marker([lat, lon], { icon: L.divIcon({ className: 'center-marker', html: `<div style="background:${color};width:10px;height:10px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 2px rgba(0,0,0,0.6)"></div>` }) });
      centerMarker.addTo(map);
      const label = name && name.length ? name : (dirVal && sectorVal ? 'æ‰‡å‹' : 'å††');
      layer.bindTooltip(`${label} #${id}`, { permanent: true, direction: 'top', offset: [0, -10], className: 'label' });
      regions.set(id, { id, type: 'circle', name, color, layer, markers: [centerMarker] });
      renderList();
      fitAll();
    }

    // åº§æ¨™ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå°æ•°6æ¡ï¼‰
    function formatLatLon(lat, lon) {
      return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }

    // æŒ‡å®šé ˜åŸŸã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºï¼ˆå¤šè§’å½¢ã¯é ‚ç‚¹ã€å††ã¯ä¸­å¿ƒï¼‰
    function showRegionMarkers(region) {
      clearRegionMarkers(region);
      if (!region || !region.layer) return;
      const color = region.color || '#22d3ee';
      if (region.type === 'polygon') {
        const latlngs = region.layer.getLatLngs();
        const pts = (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs).map(p => ({ lat: p.lat, lng: p.lng }));
        region.markers = pts.map((p, i) => {
          const m = L.marker([p.lat, p.lng], { icon: L.divIcon({ className: 'vertex-marker', html: `<div style="background:${color};color:#001018;border-radius:10px;padding:2px 6px;font-size:11px">${i + 1}</div>` }) });
          m.addTo(map);
          return m;
        });
      } else if (region.type === 'circle') {
        const c = region.layer.getLatLng();
        const m = L.marker([c.lat, c.lng], { icon: L.divIcon({ className: 'center-marker', html: `<div style="background:${color};width:10px;height:10px;border-radius:50%"></div>` }) });
        m.addTo(map);
        region.markers = [m];
      }
      // zoom to markers if any
      if (region.markers && region.markers.length) {
        const group = L.featureGroup(region.markers);
        map.fitBounds(group.getBounds().pad(0.4));
      }
    }

    function clearRegionMarkers(region) {
      if (!region || !region.markers) return;
      region.markers.forEach(m => { try { if (map.hasLayer(m)) map.removeLayer(m); } catch (e) { } });
      region.markers = [];
    }

    document.getElementById('fit-all').addEventListener('click', fitAll);

    // =============================
    //  ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    // =============================
    const VALIDATION_RULES = {
      'polygon': [
        { id: 'polygon-input', type: 'text', required: true, msg: 'é ‚ç‚¹åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { id: 'geom-name', type: 'text', required: false, msg: 'åç§°ã¯ä»»æ„ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã‚’æ¨å¥¨ã—ã¾ã™' }
      ],
      'circle': [
        { id: 'circle-center', type: 'text', required: true, msg: 'ä¸­å¿ƒåº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { id: 'circle-radius', type: 'number', required: true, msg: 'åŠå¾„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { id: 'circle-direction', type: 'number', required: false, msg: 'æ–¹è§’ã¯0ï½360ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { id: 'circle-sector-angle', type: 'number', required: false, msg: 'ç¯„å›²ã¯1ï½360ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { id: 'geom-name', type: 'text', required: false, msg: 'åç§°ã¯ä»»æ„ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã‚’æ¨å¥¨ã—ã¾ã™' }
      ]
    };

    function validateInput(type) {
      const rules = VALIDATION_RULES[type];
      if (!rules) return true;
      let isValid = true;
      rules.forEach(rule => {
        const el = document.getElementById(rule.id);
        const value = el.value.trim();
        let valid = true;
        if (rule.required && !value) {
          valid = false;
          showError(rule.msg);
        } else {
          el.classList.remove('err');
        }
        isValid = isValid && valid;
      });
      return isValid;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚
    document.getElementById('add-geom').addEventListener('click', () => {
      const type = elType.value;
      if (validateInput(type)) {
        try { if (type === 'polygon') addPolygon(); else addCircle(); showOK(); }
        catch (e) { showError(e.message || String(e)); }
      }
    });

  </script>
</body>

</html>